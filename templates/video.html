{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Video Chat</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8"> 
    <link rel="stylesheet" type="text/css" href="{% static 'fonts.css' %}">
</head>
<body>
<style>
.header img {
    width: 15vw;
    padding: 0;
    margin: 0;
}
*{
    font-family: kalameh;
}
body{
    background: linear-gradient(213deg, rgba(11, 102, 106, 1) 0%, rgb(48, 48, 48) 50%);
    /* height: 100vh; */
    background-size: cover;
    background-attachment: fixed;
}
.skip {
    background: linear-gradient(33deg, #0B666A 0%, #35A29F 100%);
    border: none;
    color: white;
    padding: 6px 24px 12px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 5vh;
    border-radius: 8px;
    cursor: pointer;
    margin-right: 1rem;
    /* margin-left: 3vh; */
    transition-duration: 0.2s;
    transition-timing-function: linear;
}
.submit {
    background-color:#0B666A;
    border: none;
    color: white;
    padding: 6px 24px 12px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 5vh;
    border-top-left-radius: 13px;
    border-bottom-left-radius: 13px;
    cursor: pointer;

    transition-duration: 0.1s;
    transition-timing-function: linear;
}
.submit:hover {background-color: #35A29F;    border-top-left-radius: 7px;
    border-bottom-left-radius: 7px;}
.bottom {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: row;
    width: 90vw;
}
.text{
    width: 70vw;
    border-top-right-radius: 13px;
    border-bottom-right-radius: 13px;
    outline: none;
    border-color:#0B666A;
    text-align: end;
    font-size: 5vh;
}

.chat {
    display: flex;
    flex-direction:row-reverse;

}
.videos {
    display: flex;
    justify-content: center;
    align-items: center;
}
video {width:40vw;height: 40vh;border-radius: 30px; box-shadow: 0 0 15px #35A29F; background-color: white;margin: 40px;}

.d{
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}

.down {
    display: flex;
    justify-content: end;
    align-items: center;
    flex-direction: column;
}
#you {
    text-align: end;
    direction: ltr;
    color: #0B666A;
    padding-right: 2rem;
}

#me {
    text-align: start;
    direction: ltr;
    color: #35A29F;
}

.messages {
    height: 20vh;
    width: 80vw;
    background-color: aliceblue;
    border-radius: 10px;
    box-shadow: 0px 10px 30px -5px rgba(0, 0, 0, 0.1);
    margin-bottom: 10px;
    overflow: auto;
}

ul {
    list-style: none;
    font-weight: 600;


}

@media (orientation : portrait) {

.header img {width: 15vh;}
.videos {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-bottom: 2rem;
    margin-top: 1rem;
    
}
video:nth-child(1) {
    justify-self: flex-end;
    height: 10vh;
    border-radius: 10px;
    margin-bottom: 1rem;
    align-self: flex-end;
    position: absolute;
    z-index: 1000;
    top: 10px;

}
video:nth-child(2) {
    height: 40vh;
}
video {width: fit-content;height: 20vh;margin: 0.1rem;border-radius: 15px;}
.bottom {flex-direction: column-reverse;}
.text {
    width: 55vw;
}
.skip {
    margin-top: 0.5rem;
    width: 60vw;
    padding: 1px 0 2px;
}
.messages {
    width: 90vw;
    
}
}

.messages::-webkit-scrollbar{
    background: transparent;
    width: 0.7rem;
    border-radius: 10px;

 }
 .messages::-webkit-scrollbar-thumb{
    background:linear-gradient(#35A29F,#0d7774);
    border-radius: 10px;
 }
 .skip:disabled {background: linear-gradient(33deg, #4d4d4d 0%, #8f8f8f 100%);transition-duration: 330ms;}
</style>

    <div class="header" id="header" >
        <a href="/">
        <img src="{% static 'beharf white.png' %}" alt="بحرف">
    </a>
    </div>
    <div class="videos">
        <video id="localVideo"  autoplay playsinline></video>
        <video id="remoteVideo"  autoplay playsinline src="{% static 'loading.mp4' %}" loop></video>
    </div>


<div class="d">
    <div class="down">
     <div class="messages">
        <ul id="ulll">

        </ul>

     </div>
    <div class="bottom">
    <button class="skip" id="skip" onclick="skip()" disabled>بعدی</button>
    <div class="chat">
        <input type="text" class="text" id="text">
        <input type="submit" class="submit" value="ارسال" onclick="send_message()">
    </div>
</div>
</div>
</div>
<script> 
let sendChannel;
let localConnection;
let remoteConnection;
let localStream;
let is_girl = false;
let is_boy = false;
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

if(isMobile) {
    console.log('hi');
    document.getElementById('header').style.display = 'none'

}
// var skip = document.getElementById('skip')
function skip(){
    ulll.innerHTML = '';
if (is_boy){

localConnection.close();
sendChannel.close();
}
else if (is_girl){

remoteConnection.close();
receiveChannel.close();
}
reconect()
}

function onConnect() {

    var skipButton = document.getElementById('skip');

    skipButton.removeAttribute('disabled');
}

function onDisconnect() {

    var skipButton = document.getElementById('skip');

    skipButton.setAttribute('disabled', '');
}

var socket = new WebSocket('wss://' + window.location.host);
var ulll = document.querySelector("#ulll")
function reconect() {
    socket = new WebSocket('wss://' + window.location.host);
    socket.onmessage = async function(event) {
    var data = JSON.parse(event.data);

    if (data.waiting_users) {
        if (data.waiting_users[0] === '{{user.username}}') {
            await boy();
            is_boy = true;
            alert('u0');
        }

        if (data.waiting_users[1] === '{{user.username}}') {
            is_girl = true;
            alert('u1');
        }
    }
    let offer = await data.offer;
    
    if (offer && is_girl) {
        await girl(offer);
    }
    let answer = await data.answer;

    if (answer && is_boy) {
        await localConnection.setRemoteDescription(new RTCSessionDescription(answer));
        console.log('bye bye bye');
    }
};

}
async function boy() {
localConnection = new RTCPeerConnection();


localConnection.onicecandidate = e => {
if (localConnection.iceGatheringState === 'complete') {
console.log("NEW ice candidate!!");
console.log(JSON.stringify(localConnection.localDescription));
socket.send(JSON.stringify({user: '{{ user.username }}', offer: localConnection.localDescription}));
}
};

sendChannel = localConnection.createDataChannel("sendChannel");
sendChannel.onmessage = e => {
let li = document.createElement('li');
li.id = 'you';
li.textContent = e.data;


ulll.appendChild(li);

}

sendChannel.onopen = e => {sendChannel.send('به {{ user.name }} {{user.age}} ساله از {{ user.city }} متصل شدید باهم دوست باشید :)');socket.send(JSON.stringify({ d: 'hola' }));socket.close();console.log('boy is connected');onConnect()}
sendChannel.onclose = e => {ulll.innerHTML = '' ;console.log("closed!");document.getElementById('remoteVideo').src = "{% static 'loading.mp4' %}";reconect() ;console.log('boy is disconnected');onDisconnect()}

let stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
document.getElementById('localVideo').srcObject = stream;

localStream = stream;
document.getElementById('localVideo').muted = true;
localStream.getTracks().forEach(track => {
localConnection.addTrack(track, localStream);
});

let offer = await localConnection.createOffer();
await localConnection.setLocalDescription(offer);

localConnection.ontrack = event => {
console.log('ontrack event fired in boy function');
if (event.streams[0]) {
console.log('Stream is defined in ontrack event');
document.getElementById('remoteVideo').srcObject = event.streams[0];
document.getElementById('remoteVideo').loop = false
} else {
console.log('Stream is not defined in ontrack event');
document.getElementById('remoteVideo').src = "{% static 'loading.mp4' %}";
document.getElementById('remoteVideo').loop = true
}
};


localConnection.onclose = event => {
    console.log('Connection closed in boy function');
    document.getElementById('remoteVideo').src = "{% static 'loading.mp4' %}";
    document.getElementById('remoteVideo').loop = true;
};

}


async function girl(offer) {
remoteConnection = new RTCPeerConnection();

remoteConnection.ontrack = event => {
if (event.streams[0]) {
document.getElementById('remoteVideo').srcObject = event.streams[0]; document.getElementById('remoteVideo').loop = false
}
else {document.getElementById('remoteVideo').src = "{% static 'loading.mp4' %}"; document.getElementById('remoteVideo').loop = true}
};

await remoteConnection.setRemoteDescription(new RTCSessionDescription(offer));
remoteConnection.ondatachannel= e => {

const receiveChannel = e.channel;
receiveChannel.onmessage =e =>  {
    let li = document.createElement('li');
li.id = 'you';
li.textContent = e.data;


ulll.appendChild(li);

}
receiveChannel.onopen = e =>  {remoteConnection.channel.send('به {{ user.name }} {{user.age}} ساله از {{ user.city }} متصل شدید باهم دوست باشید :)'); socket.close() ; console.log('girl is connected');onConnect()}

receiveChannel.onclose =e => {ulll.innerHTML = '';console.log("closed!!!!!!"); document.getElementById('remoteVideo').src = "{% static 'loading.mp4' %}";reconect(); console.log('girl is disconnected');onDisconnect()}
remoteConnection.channel = receiveChannel;

}
let stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });//{ facingMode: { ideal: "user" } }
document.getElementById('localVideo').srcObject = stream;
document.getElementById('localVideo').muted = true;
stream.getTracks().forEach(track => {
remoteConnection.addTrack(track, stream);
});

let answer = await remoteConnection.createAnswer();
await remoteConnection.setLocalDescription(answer);

remoteConnection.onclose = event => {
    console.log('Connection closed in girl function');
    document.getElementById('remoteVideo').src = "{% static 'loading.mp4' %}";
    document.getElementById('remoteVideo').loop = true;
};

socket.send(JSON.stringify({ user: '{{user.username}}', answer: remoteConnection.localDescription }));
}

function girl_message(message){

var li = document.createElement("li");


li.id = "me";


li.textContent = message;

var ul = document.querySelector("#ulll");
remoteConnection.channel.send(message)
document.getElementById('text').value = ''
ul.appendChild(li);
}
function boy_message(message){
var li = document.createElement("li");
li.id = "me";
li.textContent = message;

var ul = document.querySelector("#ulll");
sendChannel.send(message)
document.getElementById('text').value = ''
ul.appendChild(li);

}

let offerPromise = new Promise(resolve => {
  socket.onmessage = function(event) {
    var data = JSON.parse(event.data);
    if (data.offer) {
      resolve(data.offer);
    }
  };
});
socket.onopen= () => {console.log('یه سوکت باز شد');}
socket.onmessage = async function(event) {
    var data = JSON.parse(event.data);

    if (data.waiting_users) {
        if (data.waiting_users[0] === '{{user.username}}') {
            await boy();
            is_boy = true;
        }

        if (data.waiting_users[1] === '{{user.username}}') {
            is_girl = true;
        }
    }
    let offer = await data.offer;
    
    if (offer && is_girl) {
        await girl(offer);
    }
    let answer = await data.answer;

    if (answer && is_boy) {
        await localConnection.setRemoteDescription(new RTCSessionDescription(answer));
        console.log('bye bye bye');
    }
};



socket.onclose = (event) => {
console.log('WebSocket connection closed with code ' + event.code);
};

function send_message(){
let message = document.getElementById('text').value
console.log(message)
if (is_boy){
boy_message(message)

}
else if (is_girl){
girl_message(message)
message = '';
}
}


const textInput = document.getElementById('text');
    textInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        send_message()
      }
    });

</script>
</body>
</html>
